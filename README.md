# K3rs

> ğŸš§ **Experimental â€” under heavy development.**
> This project is an experiment in AI-driven software development. The vast majority of the code, architecture, tests, and documentation were generated by AI ([Claude Code](https://code.claude.com/docs) & [Google Antigravity](https://antigravity.google/)). Humans direct architecture, priorities, and design decisions, but have not reviewed most of the code line-by-line. Treat this accordingly â€” there will be bugs, rough edges, and things that don't work yet. **Use at your own risk.**

**A lightweight container orchestration platform written in Rust.**

Inspired by [K3s](https://k3s.io/), powered by [Cloudflare Pingora](https://github.com/cloudflare/pingora), [Axum](https://docs.rs/axum), and [SlateDB](https://slatedb.io/). See the full [specification](spec.md) for architecture details, API reference, and store schema.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  k3rs-server (Control Plane)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ API      â”‚ â”‚ Scheduler â”‚ â”‚ Controller Manager          â”‚ â”‚
â”‚  â”‚ (Axum)   â”‚ â”‚           â”‚ â”‚ (8 controllers)             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ SlateDB  â”‚ â”‚ Leader    â”‚ â”‚ PKI / CA â”‚                    â”‚
â”‚  â”‚ (S3/R2)  â”‚ â”‚ Election  â”‚ â”‚ (mTLS)   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                           â–²
        â”‚  mTLS                     â”‚  mTLS
        â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  k3rs-agent      â”‚  â”‚  k3rs-agent      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Container  â”‚  â”‚  â”‚  â”‚ Container  â”‚  â”‚
â”‚  â”‚ Runtime    â”‚  â”‚  â”‚  â”‚ Runtime    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Service    â”‚  â”‚  â”‚  â”‚ Service    â”‚  â”‚
â”‚  â”‚ Proxy      â”‚  â”‚  â”‚  â”‚ Proxy      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ DNS Server â”‚  â”‚  â”‚  â”‚ DNS Server â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [Pod] [Pod]     â”‚  â”‚  [Pod] [Pod]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Features

- **Pure Rust** â€” memory-safe, single binary per component
- **Control Plane / Data Plane** â€” server never touches containers; agents execute
- **Fail-Static** â€” restart server or agent without disrupting running pods
- **SlateDB** â€” embedded state store on object storage (S3/R2/MinIO), no etcd
- **Pingora** â€” L4/L7 service proxy, tunnel proxy, ingress controller
- **Platform-Aware Runtime** â€” Virtualization.framework microVMs (macOS), Firecracker (Linux), youki/crun OCI (Linux)
- **Management UI** â€” Dioxus 0.7 web dashboard
- **Backup/Restore** â€” online backup & restore via API, multi-server safe

## Quick Start

### Prerequisites

- **Rust** 1.93.1+ (edition 2024)
- **macOS** (primary dev platform) or **Linux**

### Run the Server

```bash
# Clone
git clone https://github.com/AssetsArt/k3rs.git
cd k3rs

# Start server (port 6443, local SlateDB)
cargo run --bin k3rs-server -- \
  --port 6443 \
  --token demo-token-123 \
  --data-dir /var/lib/k3rs/server \
  --node-name master-1
```

### Run an Agent

```bash
cargo run --bin k3rs-agent -- \
  --server http://127.0.0.1:6443 \
  --token demo-token-123 \
  --node-name node-1
```

### CLI

```bash
# Cluster info
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 cluster info

# List nodes
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 node list

# Apply a manifest
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 apply -f manifest.yaml

# Get resources
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 get pods
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 get deployments
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 get services

# Logs & exec
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 logs <pod-name>
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 exec <pod-name> -- <command>

# Node operations
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 node drain <node-name>
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 node cordon <node-name>
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 node uncordon <node-name>

# Backup & restore
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 backup create --output ./backup.k3rs-backup.json.gz
cargo run --bin k3rsctl -- --server http://127.0.0.1:6443 restore --from ./backup.k3rs-backup.json.gz
```

## Development

### Dev Scripts (macOS)

```bash
# Full dev environment (tmux: server + UI)
./scripts/dev.sh

# Server only (cargo-watch auto-reload)
./scripts/dev-server.sh

# Agent only
./scripts/dev-agent.sh

# UI only (Dioxus)
./scripts/dev-ui.sh
```

### Dev with Podman (Linux â€” OCI & Firecracker)

For testing OCI runtimes (youki/crun) and Firecracker on Linux:

```bash
# Interactive shell with Linux environment
./scripts/dev-podman.sh

# Run server inside container
./scripts/dev-podman.sh server

# Run agent inside container
./scripts/dev-podman.sh agent

# Run tests
./scripts/dev-podman.sh test

# With KVM passthrough (Firecracker)
./scripts/dev-podman.sh --kvm shell

# With ALL
./scripts/dev-podman.sh --all --ui

# Environment variables
K3RS_RUNTIME=crun ./scripts/dev-podman.sh agent   # use crun instead of youki
K3RS_KVM=1 ./scripts/dev-podman.sh agent           # enable KVM
```

The Podman container includes: Rust toolchain, youki, crun, Firecracker, cargo-watch, and persistent cargo cache volumes.

### Build k3rs-init (Guest VM PID 1)

```bash
# Cross-compile from macOS â†’ Linux musl (static binary)
cargo zigbuild --release --target aarch64-unknown-linux-musl -p k3rs-init

# Or build kernel + initrd for microVMs
./scripts/build-kernel.sh
```

### Configuration

Both server and agent support YAML config files:

**Server** (`/etc/k3rs/config.yaml`):
```yaml
port: 6443
data-dir: /var/lib/k3rs/server
token: my-secret-token
```

**Agent** (`/etc/k3rs/agent-config.yaml`):
```yaml
server: https://10.0.0.1:6443
token: my-secret-token
node-name: worker-1
dns-port: 5353
```

Config precedence: **CLI flags** > **YAML config** > **defaults**

### Path Layout

All paths are derived from 3 base constants defined in `pkg/constants/src/paths.rs`:

| Constant | Value | Purpose |
|---|---|---|
| `CONFIG_DIR` | `/etc/k3rs` | Configuration, TLS certs |
| `DATA_DIR` | `/var/lib/k3rs` | State, runtime, binaries, kernel |
| `LOG_DIR` | `/var/logs/k3rs` | Log files |

**Uninstall:** `rm -rf /etc/k3rs /var/lib/k3rs /var/logs/k3rs`

## Architecture

### Control Plane (k3rs-server)

The server is a **pure control plane** â€” it never runs containers:

| Component | Purpose |
|---|---|
| **API Server** (Axum) | REST API for all cluster operations |
| **Scheduler** | Resource-aware pod placement with affinity/taint support |
| **Controller Manager** | 8 controllers: Node, Deployment, ReplicaSet, DaemonSet, Job, CronJob, HPA, Eviction |
| **SlateDB** | Embedded KV store on object storage (S3/R2/local) |
| **Leader Election** | Lease-based HA â€” only leader runs controllers |
| **PKI / CA** | Issues mTLS certificates to agents |
| **Metrics** | Prometheus-compatible `/metrics` endpoint |

### Data Plane (k3rs-agent)

The agent runs on worker nodes and manages the container lifecycle:

| Component | Purpose |
|---|---|
| **Pod Sync Loop** | Watches scheduled pods â†’ pull image â†’ create â†’ start â†’ monitor |
| **Container Runtime** | Platform-aware: Virtualization.framework (macOS), Firecracker/youki/crun (Linux) |
| **Service Proxy** (Pingora) | L4/L7 load balancing, replaces kube-proxy |
| **Tunnel Proxy** (Pingora) | Persistent reverse tunnel to server |
| **DNS Server** | Resolves `<svc>.<ns>.svc.cluster.local` |
| **CNI** | Pod IP allocation from CIDR block |

### Container Runtime

| Platform | Backend | Technology |
|---|---|---|
| macOS | `VirtualizationBackend` | Apple Virtualization.framework microVMs |
| Linux (KVM) | `FirecrackerBackend` | Firecracker via rust-vmm crates |
| Linux (no KVM) | `OciBackend` | youki / crun OCI runtimes |

### State Store

All cluster state lives in SlateDB under structured key prefixes:

```
/registry/nodes/<name>                   â†’ Node metadata & status
/registry/namespaces/<ns>                â†’ Namespace definition
/registry/pods/<ns>/<name>               â†’ Pod spec & status
/registry/deployments/<ns>/<name>        â†’ Deployment spec & status
/registry/replicasets/<ns>/<name>        â†’ ReplicaSet spec & status
/registry/daemonsets/<ns>/<name>         â†’ DaemonSet spec & status
/registry/jobs/<ns>/<name>               â†’ Job spec & status
/registry/cronjobs/<ns>/<name>           â†’ CronJob spec & status
/registry/services/<ns>/<name>           â†’ Service definition
/registry/endpoints/<ns>/<name>          â†’ Endpoint slice
/registry/ingresses/<ns>/<name>          â†’ Ingress rules
/registry/configmaps/<ns>/<name>         â†’ ConfigMap data
/registry/secrets/<ns>/<name>            â†’ Secret data (encrypted)
/registry/hpa/<ns>/<name>                â†’ Horizontal Pod Autoscaler
/registry/resourcequotas/<ns>/<name>     â†’ Resource quota
/registry/networkpolicies/<ns>/<name>    â†’ Network policy
/registry/pvcs/<ns>/<name>               â†’ Persistent volume claim
/registry/images/<node-name>             â†’ Per-node image list
/registry/leases/controller-leader       â†’ Leader election lease
```

### Fail-Static Guarantees

**Restart any component without disrupting running workloads.**

| Scenario | Running Containers | Service Proxy | DNS |
|---|---|---|---|
| **Server restart** | âœ… Unaffected | âœ… Continues | âœ… Continues |
| **Agent restart** | âœ… Independent processes | âŒâ†’âœ… Restarts | âŒâ†’âœ… Restarts |
| **Server + Agent restart** | âœ… Unaffected | âŒâ†’âœ… Restarts | âŒâ†’âœ… Restarts |

Key invariant: `kill -9 <agent-pid>` must **never** cause any container to stop.

## Workload Resources

| Resource | Description |
|---|---|
| **Pod** | Smallest deployable unit |
| **Deployment** | Manages ReplicaSets, rolling updates, blue/green, canary |
| **ReplicaSet** | Maintains N pod replicas |
| **DaemonSet** | One pod per node (or selected nodes) |
| **Job** | Run-to-completion workload |
| **CronJob** | Scheduled jobs |
| **Service** | ClusterIP / NodePort / LoadBalancer |
| **Ingress** | Host/path-based external routing |
| **ConfigMap** | Configuration data |
| **Secret** | Sensitive data (encrypted at rest) |
| **HPA** | Horizontal Pod Autoscaler |
| **NetworkPolicy** | Pod-level network isolation |
| **ResourceQuota** | Per-namespace limits |
| **PVC** | Persistent volume claims |

## Security

- **mTLS everywhere** â€” Server â†” Agent, auto-rotated certificates
- **Join token** â€” Agents register with pre-shared token, receive TLS cert
- **RBAC** â€” `cluster-admin`, `namespace-admin`, `viewer` roles
- **Service accounts** â€” Scoped tokens for workload API access
- **Secrets encrypted at rest** in SlateDB

## Project Structure

```
k3rs/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ k3rs-server/       # Control plane binary
â”‚   â”œâ”€â”€ k3rs-agent/        # Data plane binary
â”‚   â”œâ”€â”€ k3rs-init/         # Guest PID 1 for microVMs (static musl binary)
â”‚   â”œâ”€â”€ k3rs-vmm/          # Virtualization.framework helper (macOS, Rust + objc2-virtualization)
â”‚   â”œâ”€â”€ k3rs-ui/           # Management UI (Dioxus 0.7)
â”‚   â””â”€â”€ k3rsctl/           # CLI tool
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ api/               # Axum HTTP API & handlers
â”‚   â”œâ”€â”€ constants/         # Centralized constants (paths, network, runtime, auth, state, vm)
â”‚   â”œâ”€â”€ container/         # Container runtime (Virtualization/Firecracker/OCI)
â”‚   â”œâ”€â”€ controllers/       # 8 control loops
â”‚   â”œâ”€â”€ metrics/           # Prometheus metrics registry
â”‚   â”œâ”€â”€ network/           # CNI + DNS
â”‚   â”œâ”€â”€ pki/               # CA & mTLS certificates
â”‚   â”œâ”€â”€ proxy/             # Pingora proxies (Service/Ingress/Tunnel)
â”‚   â”œâ”€â”€ scheduler/         # Pod placement logic
â”‚   â”œâ”€â”€ state/             # SlateDB integration
â”‚   â””â”€â”€ types/             # Cluster object models
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ dev.sh             # Full dev environment (tmux)
â”‚   â”œâ”€â”€ dev-agent.sh       # Agent dev loop
â”‚   â”œâ”€â”€ dev-podman.sh      # Podman Linux dev environment
â”‚   â”œâ”€â”€ build-kernel.sh    # Build Linux kernel + initrd for microVMs
â”‚   â””â”€â”€ ...
â”œâ”€â”€ Containerfile.dev      # Podman dev image (Rust + youki + crun + Firecracker)
â”œâ”€â”€ Cargo.toml             # Workspace root (15 crates)
â””â”€â”€ spec.md                # Full specification
```

## Tech Stack

| Category | Technology |
|---|---|
| Language | Rust (edition 2024) |
| HTTP API | Axum 0.8 |
| Proxy / Networking | Cloudflare Pingora 0.7 |
| State Store | SlateDB 0.10 on object storage |
| Management UI | Dioxus 0.7 (WASM SPA) |
| Container Runtime | Virtualization.framework / Firecracker / youki / crun |
| Image Pull | oci-client (OCI Distribution spec) |
| DNS | Hickory DNS |
| Serialization | serde + serde_json |
| Async Runtime | Tokio |
| CLI | Clap |
| TLS | rustls + rcgen |
| Telemetry | OpenTelemetry + OTLP |

## License

MIT
